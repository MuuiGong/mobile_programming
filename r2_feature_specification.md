# R² (Risk and Reward) — 기능 명세서 (Feature Specification)

---

## 📋 목차

1. 핵심 기능 (Core Features) - 5가지
2. 각 기능별 상세 설명
3. 사용 흐름
4. 데이터 저장
5. 알림 시스템

---

## 🎯 핵심 기능 (Core Features) — 5가지

### 1️⃣ **거래 실행 및 자동 관리**
### 2️⃣ **실시간 위험도 평가 (Risk Score)**
### 3️⃣ **마진 모니터링 & 자동 청산**
### 4️⃣ **거래 기록 & 성과 분석**
### 5️⃣ **AI 코치 & 행동 피드백**

---

## 1️⃣ 거래 실행 및 자동 관리

### 1-1. 거래 진입 (Entry)

**사용자 액션:**
1. 대시보드에서 "+ 새 거래" 클릭
2. 거래 화면으로 이동
3. TradingView 차트에서:
   - Entry 가격 드래그로 설정
   - TP (익절가) 설정
   - SL (손절가) 설정
4. 레버리지 선택 (1x ~ 20x)
5. "거래 진입" 버튼 클릭

**앱의 작업:**
```
사용자가 버튼 클릭
  ↓
거래 검증 (Entry/TP/SL 정상 여부)
  ↓
거래 크기 계산
  ├─ 현물: 위험자금 / (Entry - SL)
  └─ 선물: (위험자금 × 레버리지) / (Entry - SL)
  ↓
Position 생성
  ├─ positionId: 자동 생성
  ├─ entryPrice: 사용자 입력
  ├─ currentPrice: Entry 가격
  ├─ tp, sl: 사용자 입력
  ├─ leverage: 사용자 선택
  ├─ status: "OPEN"
  └─ entryTime: 현재 시간
  ↓
실시간 가격 모니터링 시작 (1초 단위)
  ↓
거래 기록 저장 (로컬 DB)
```

**결과:**
- ✅ 포지션이 활성 상태로 변경
- ✅ 대시보드 "활성 포지션" 섹션에 표시
- ✅ 실시간 모니터링 시작

---

### 1-2. 실시간 가격 모니터링

**동작:**
```
매 1초마다:
  1. CoinGecko API에서 현재 가격 조회
  2. Position.currentPrice 업데이트
  3. P&L 재계산
  4. TP/SL 도달 확인
  5. UI 갱신
```

**계산:**
```
P&L = (currentPrice - entryPrice) × tradeSize × leverage
P&L% = (P&L / (tradeSize × entryPrice)) × 100

예시 (5x 레버리지):
  Entry: $95,836 | Current: $96,500 | TP: $97,752 | SL: $93,919
  P&L = (96,500 - 95,836) × 0.0052 × 5 = +$17.28
  P&L% = +17.28%
```

---

### 1-3. 자동 익절 (TP Hit)

**조건:**
```
IF currentPrice >= TP:
  → 자동 종료 (거래 완전 종료)
```

**동작:**
```
1. 포지션 상태: "OPEN" → "CLOSED"
2. 종료 가격: TP 가격
3. 종료 시간: 현재 시간
4. 종료 이유: "TP_HIT"
5. P&L 최종 계산
6. 잔고 업데이트
7. 거래 기록 저장
8. 사용자 알림 발송
```

**알림:**
```
팝업: "익절! TP 도달"
제목: "거래가 종료되었습니다"
내용: "Entry: $95,836 | TP: $97,752.72"
      "수익: +$49.95 | 누적 잔고: $10,049.95"
음성: 성공 알림음
```

---

### 1-4. 자동 손절 (SL Hit)

**조건:**
```
IF currentPrice <= SL:
  → 자동 종료 (거래 완전 종료)
```

**동작:**
```
1. 포지션 상태: "OPEN" → "CLOSED"
2. 종료 가격: SL 가격
3. 종료 시간: 현재 시간
4. 종료 이유: "SL_HIT"
5. P&L 최종 계산 (음수)
6. 잔고 업데이트 (감소)
7. 거래 기록 저장
8. 사용자 알림 발송
```

**알림:**
```
팝업: "손절! SL 도달"
제목: "거래가 종료되었습니다"
내용: "Entry: $95,836 | SL: $93,919.28"
      "손실: -$49.95 | 누적 잔고: $9,950.05"
음성: 경고 알림음
```

---

### 1-5. 타임아웃 종료 (선택 사항)

**설정:**
```
사용자가 포지션 최대 지속 시간 설정 가능:
  - 무제한 (기본)
  - 1시간
  - 4시간
  - 24시간
```

**동작:**
```
IF positionDuration >= maxDuration:
  → 현재 가격으로 자동 종료
  → 종료 이유: "TIMEOUT"
```

---

## 2️⃣ 실시간 위험도 평가 (Risk Score)

### 2-1. Risk Score 공식

```
Risk Score = 100 - (0.4 × Volatility + 0.4 × MDD + 0.2 × NegativeSharpe)

여기서:
- Volatility: 수익의 표준편차 (변동성)
- MDD: Maximum Drawdown (최대 낙폭)
- NegativeSharpe: Sharpe Ratio가 음수면 |Sharpe|, 양수면 0
```

### 2-2. Risk Score 해석

```
🟢 71-100: 안정적 (좋음)
   → 잘 관리되는 거래
   → 리스크가 적절함
   → 계속 거래 가능

🟡 31-70: 주의 (주의 필요)
   → 위험도가 증가중
   → 리스크 관리 개선 권고
   → 신중하게 거래

🔴 0-30: 위험 (즉시 개선)
   → 위험도가 매우 높음
   → 리스크 관리 시급
   → 포지션 축소 권고
```

### 2-3. 각 거래별 Risk Score 표시

```
거래 진입 전:
  현재 설정된 Entry/TP/SL에 대한 예상 Risk Score 표시
  
거래 진입 후:
  실시간으로 갱신되는 Risk Score 표시
  
매 1초마다 업데이트됨
```

### 2-4. Risk Score 영향 요소

| 요소 | 영향도 | 설명 |
|------|--------|------|
| Volatility | 40% | 수익 변동이 크면 위험 증가 |
| Max Drawdown | 40% | 최대 낙폭이 크면 위험 증가 |
| Sharpe Ratio | 20% | 위험대비 수익이 낮으면 위험 증가 |
| Win Rate | 간접영향 | 승률이 낮으면 Sharpe 악화 |
| R:R Ratio | 간접영향 | 수익손실 비율이 나쁘면 악화 |

---

## 3️⃣ 마진 모니터링 & 자동 청산

### 3-1. 마진 계산 (선물 거래만)

```
필요 증거금 (Required Margin):
  = 거래 규모 / 레버리지
  = (Entry × tradeSize) / leverage

사용 마진 (Used Margin):
  = 필요 증거금 + 거래 비용
  = (Entry × tradeSize) / leverage + (Entry × tradeSize × 0.001)

가용 마진 (Available Margin):
  = 총 마진 + 현재 P&L - 사용 마진

마진 비율 (Margin Ratio):
  = (가용 마진 / 사용 마진) × 100 (%)
```

**예시:**
```
초기 자금: $100 (레버리지 5x)
거래 규모: $100 × 5 = $500
필요 증거금: $500 / 5 = $100
사용 마진: $100 + $0.50 = $100.50

현재 가격: $96,500 (Entry: $95,836)
P&L: +$33.30
가용 마진: $100 + $33.30 - $100.50 = $32.80
마진 비율: ($32.80 / $100.50) × 100 = 32.6%
```

### 3-2. 3단계 마진 경고

#### 🟢 정상 (마진 100% 이상)
```
상태: 안전
마진 비율: > 100%
조치: 계속 거래 가능
UI: 녹색 표시
```

#### 🟡 마진콜 경고 (마진 50% ~ 100%)
```
상태: 주의
마진 비율: 50% ~ 100%
조치:
  1. 팝업 경고 표시
  2. 상단 배너 노출
  3. Risk Score 빨간색 표시
  4. "긴급 포지션 종료" 버튼 활성화
UI: 노란색 표시
```

#### 💥 자동 청산 (마진 0% 이하)
```
상태: 청산됨
마진 비율: ≤ 0%
동작:
  1. 포지션 자동 강제 종료
  2. 청산 가격: 현재 가격
  3. 종료 이유: "LIQUIDATION"
  4. 거래 기록 저장
  5. 청산 알림 발송
UI: 빨간색 표시
```

### 3-3. 자동 청산 상세 프로세스

```
실시간 모니터링 (0.5초 단위):
  ↓
마진 비율 계산
  ↓
마진 비율 ≤ 0% 확인
  ↓
YES → 청산 프로세스 시작
  ↓
1. 청산 가격 계산 (현재 가격)
2. 청산 P&L 계산
3. 포지션 종료
4. Trade 기록 생성 (exitReason: "LIQUIDATION")
5. 잔고 업데이트
6. 알림 발송
7. UI 갱신
```

**청산 알림:**
```
팝업: "포지션 청산!"
제목: "마진이 부족하여 포지션이 강제 종료되었습니다"
내용: "Entry: $95,836 | 청산가: $93,800"
      "손실: -$100.00 (모든 마진 소진)"
음성: 경고음
색상: 빨강
심각도: 최고
```

---

## 4️⃣ 거래 기록 & 성과 분석

### 4-1. 거래 기록 자동 저장

**저장 정보:**
```
{
  "tradeId": "trade_20251116_001",
  "symbol": "BTCUSDT",
  "timeframe": "1H",
  "tradeType": "FUTURES",
  "leverage": 5,
  
  "entryTime": "2025-11-16T18:00:00Z",
  "entryPrice": 95836.00,
  "tp": 97752.72,
  "sl": 93919.28,
  "tradeSize": 0.005220,
  
  "exitTime": "2025-11-16T18:45:00Z",
  "exitPrice": 97752.72,
  "exitReason": "TP_HIT",  // 또는 SL_HIT, LIQUIDATION, TIMEOUT
  
  "pnl": 49.95,
  "pnlPercent": 49.95,
  "rrRatio": 1.24,
  "duration": "00:45:00",
  
  "status": "CLOSED"
}
```

### 4-2. 거래 기록 조회

**거래 기록 화면 (HistoryActivity):**

```
필터링:
  - 날짜: [오늘] [이번주] [이번달] [전체]
  - 결과: [전체] [수익] [손실]
  - 심볼: [모두] [BTCUSDT] [ETHUSDT] ...

거래 목록:
  # | 심볼 | 시간 | 수익/손실 | 상태
  1 | BTC | 18:45 | +$49.95 | ✓TP
  2 | ETH | 17:30 | -$23.50 | ✗SL
  3 | BTC | 17:00 | +$100.00 | ✓TP
  ...

통계 요약:
  - 총 거래: 5회
  - 수익: 3회 (60%)
  - 손실: 2회 (40%)
  - 총 P&L: +$250.55
  - 평균 R:R: 1.18:1
```

### 4-3. 성과 분석

**분석 화면 (AnalysisActivity):**

```
📊 성과 지표:
  - 총 거래: 50회
  - 승률: 62%
  - 손실률: 38%
  - 총 수익: +$2,450.50
  - 평균 수익: +$49.01
  - 평균 손실: -$32.50
  - 최대 수익: +$250.00
  - 최대 손실: -$150.00
  
📈 성과 그래프:
  - X축: 날짜 (시간 경과)
  - Y축: 누적 잔고 ($)
  - 수익 곡선 시각화

📉 위험 분석:
  - Sharpe Ratio: 1.45
  - Max Drawdown: -12.5%
  - Recovery Rate: 95%
```

---

## 5️⃣ AI 코치 & 행동 피드백

### 5-1. 감지되는 거래 패턴

#### ⚠️ 위험한 패턴
```
1. Overtrading (과도한 거래)
   → 1시간 내 거래 5회 이상
   → 피드백: "거래가 너무 많습니다. 숨을 고르세요."

2. Loss Aversion (손실 회복 시도)
   → 연속 손실 후 거래 크기 2배 이상 증가
   → 피드백: "손실 회복 욕구가 감지됩니다. 차분하세요."

3. Moving Stop-Loss (손절 변경)
   → 포지션 진입 후 SL을 위로 이동
   → 피드백: "손절을 변경하고 있습니다. 규칙을 지키세요."

4. Impulsive Entry (충동적 진입)
   → 차트 확인 후 3초 내 거래 진입
   → 피드백: "너무 빠르게 진입하고 있습니다."

5. Consecutive Losses (연속 손실)
   → 연속 3회 이상 손실
   → 피드백: "연속 손실이 발생했습니다. 규칙을 재검토하세요."
```

#### ✅ 좋은 패턴
```
1. Planned Entry (계획된 진입)
   → 차트 충분히 분석 후 진입
   → 피드백: "좋은 준비 거래입니다!"

2. Consistent R:R (일관된 수익손실 비율)
   → 모든 거래에서 R:R ≥ 1.0:1 유지
   → 피드백: "R:R 비율이 좋습니다. 계속 유지하세요."

3. Stop Loss Discipline (손절 규칙 준수)
   → SL을 설정한 대로 유지
   → 피드백: "손절 규칙을 잘 따르고 있습니다!"

4. Position Sizing (적절한 거래 크기)
   → 일관된 거래 크기 유지
   → 피드백: "포지션 크기 관리가 좋습니다."

5. Profit Taking (체계적 익절)
   → TP에서 정확히 익절
   → 피드백: "익절 규칙을 잘 지키고 있습니다!"
```

### 5-2. AI 코치 피드백 예시

**피드백 화면:**
```
AI 코치로부터:

"최근 3거래가 모두 손절입니다.
 당신의 SL 범위가 좁은 것 같습니다.
 
 현재: 평균 SL = 1.2%
 추천: SL을 2~3% 범위로 확대하세요.
 
 더 넓은 SL 범위로 시작하면
 더 나은 성과를 볼 수 있을 겁니다."

🎯 추천 조치:
  1. SL을 1~2% 더 넓혀보세요
  2. 다음 5거래에서 테스트하세요
  3. 결과를 분석해보세요
```

---

## 📊 사용 흐름 (User Flow)

### 전체 거래 플로우

```
1. 앱 실행
   ↓
2. 대시보드 보기
   [계정] [Risk Score] [활성 포지션]
   ↓
3. "+ 새 거래" 클릭
   ↓
4. 거래 화면 이동
   ├─ TradingView 차트 로드
   ├─ Entry/TP/SL 설정
   ├─ 레버리지 선택
   └─ R:R 비율 확인
   ↓
5. Risk Score 확인
   ✅ 75/100 (안정) → 진입 가능
   🟡 50/100 (주의) → 신중히 진입
   🔴 25/100 (위험) → 진입 권고하지 않음
   ↓
6. "거래 진입" 버튼 클릭
   ↓
7. 실시간 모니터링 시작
   (매 1초마다)
   ├─ 가격 업데이트
   ├─ P&L 계산
   ├─ 마진 비율 계산
   └─ TP/SL 확인
   ↓
8. TP 도달
   ↓
9. 자동 익절
   ↓
10. 거래 기록 저장
    ↓
11. 알림 발송
    ↓
12. 대시보드로 돌아가기
    (누적 잔고 업데이트)
```

---

## 💾 데이터 저장 (Local DB - Room SQLite)

### 저장되는 테이블

```
trades 테이블:
  - tradeId (PK)
  - symbol, timeframe, tradeType
  - entryPrice, entryTime
  - tp, sl, leverage
  - exitPrice, exitTime, exitReason
  - pnl, pnlPercent, rrRatio
  - duration, status

positions 테이블:
  - positionId (PK)
  - symbol, entryPrice
  - tp, sl, leverage
  - currentPrice, pnl, pnlPercent
  - marginRatio, liquidationPrice
  - entryTime, status

users 테이블:
  - userId (PK)
  - initialBalance
  - tradeMode, defaultLeverage
  - riskAmount, maxPositions
```

---

## 🔔 알림 시스템 (Notification)

### 알림 종류

| 이벤트 | 제목 | 색상 | 음성 | 심각도 |
|--------|------|------|------|--------|
| **TP 도달** | 익절! TP 도달 | 🟢 | ✓ 성공음 | 낮음 |
| **SL 도달** | 손절! SL 도달 | 🔴 | ✓ 경고음 | 중간 |
| **마진콜** | 마진콜 경고! | 🟡 | ✓ 주의음 | 높음 |
| **청산** | 포지션 청산! | 🔴 | ✓ 경고음 | 최고 |
| **일일한도** | 일일 손실 한도 도달 | 🔴 | ✓ 경고음 | 중간 |

---

## 📝 요약

### R² 앱의 기능 정리

| # | 기능 | 설명 | 시작점 |
|---|------|------|--------|
| 1 | 거래 진입 | 차트에서 Entry/TP/SL 설정 후 거래 시작 | "새 거래" |
| 2 | 자동 모니터링 | 1초 단위로 가격 업데이트 및 P&L 계산 | 자동 |
| 3 | 자동 익절 | TP 도달 시 자동 종료 | 자동 |
| 4 | 자동 손절 | SL 도달 시 자동 종료 | 자동 |
| 5 | Risk Score | 거래 위험도 0-100으로 평가 | 자동 |
| 6 | 마진 모니터링 | 실시간 마진 비율 계산 (선물만) | 자동 |
| 7 | 자동 청산 | 마진 부족 시 강제 종료 | 자동 |
| 8 | 거래 기록 | 모든 거래 자동 저장 | 자동 |
| 9 | 성과 분석 | Sharpe, MDD 등 계산 | "분석" |
| 10 | AI 코치 | 거래 패턴 분석 및 피드백 | 자동 |

---

**이제 기능이 명확하죠?** ✅

